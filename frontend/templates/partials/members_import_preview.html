<!--
===============================================================================
Project   : gratulo
Module    : frontend/templates/partials/members_import_preview.html
Created   : 2025-10-05
Author    : Florian
Purpose   : Dynamic template used to show the preview of the imported members

@docstyle: google
@language: english
@voice: imperative
===============================================================================
-->


<div id="import-area" class="bg-white shadow rounded-lg" style="height: 500px; display: flex; flex-direction: column;">

  <div style="flex-shrink: 0; padding: 1rem;">
    {% if banner_error %}
    <div class="p-3 rounded bg-red-100 text-red-800 border border-red-300 text-sm font-medium mb-4">
      {{ banner_error }}
    </div>
    {% endif %}

    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-800">CSV Import - Validierungsergebnis</h3>
      <div class="flex items-center gap-4">
        {% set error_count = rows | selectattr('_errors') | list | length %}
        {% set warning_count = rows | selectattr('_warnings') | list | length %}
        {% if error_count > 0 %}
          <div class="badge badge-red">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">{{ error_count }} Fehler gefunden</span>
          </div>
        {% elif warning_count > 0 %}
          <div class="badge badge-yellow">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">{{ warning_count }} Warnungen (z.B. doppelte E-Mails)</span>
          </div>
        {% else %}
          <div class="badge badge-green">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">Alle Zeilen OK</span>
          </div>
        {% endif %}
        <div class="text-sm text-gray-500">
          {{ rows|length }} Zeilen geladen
        </div>
      </div>
    </div>

    {% set error_count = rows | selectattr('_errors') | list | length %}
    {% set warning_count = rows | selectattr('_warnings') | list | length %}
    {% if error_count > 0 or warning_count > 0 %}
    <div class="mb-3">
      <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
        <input type="checkbox" id="show-only-errors" class="rounded border-gray-300" checked
               onchange="document.querySelectorAll('#import-form tbody tr').forEach(tr => { 
                 if (this.checked) {
                   tr.style.display = (tr.classList.contains('bg-red-50') || tr.classList.contains('bg-yellow-50')) ? '' : 'none';
                 } else {
                   tr.style.display = '';
                 }
               })">
        Nur Zeilen mit Fehlern/Warnungen anzeigen 
        ({{ error_count }} Fehler, {{ warning_count }} Warnungen von {{ rows|length }} Zeilen)
      </label>
    </div>
    {% endif %}
  </div>

  <form id="import-form" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
    <div style="flex: 1; min-height: 0; overflow-y: auto; overflow-x: hidden; will-change: scroll-position; -webkit-overflow-scrolling: touch;">
      <table class="w-full divide-y divide-gray-200 table-fixed">
        <thead class="bg-gray-50" style="position: sticky; top: 0; z-index: 10; transform: translateZ(0); backface-visibility: hidden;">
          <tr>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 4%;">#</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 12%;">Vorname</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 12%;">Nachname</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 15%;">E-Mail</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 12%;">Geburtsdatum</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 10%;">Geschlecht</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 12%;">Mitglied seit</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 12%;">Gruppe</th>
            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider bg-gray-50" style="width: 11%;">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 text-sm text-gray-700">
          {% for r in rows %}
            {% set i = loop.index0 %}
            {% set e = r.get("_errors", {}) %}
            {% set w = r.get("_warnings", {}) %}
            {% set error_count = rows | selectattr('_errors') | list | length %}
            {% set warning_count = rows | selectattr('_warnings') | list | length %}
            {% set has_issues = (error_count > 0 or warning_count > 0) %}
            {% set row_has_issue = (e and e|length > 0) or (w and w|length > 0) %}
            <tr class="{% if e and e|length > 0 %}bg-red-50{% elif w and w|length > 0 %}bg-yellow-50{% else %}hover:bg-gray-50{% endif %}" 
                {% if has_issues and not row_has_issue %}style="display: none;"{% endif %}>
              <td class="px-3 py-2 font-medium text-gray-900">{{ loop.index }}</td>

              <td class="px-3 py-2">
                <input name="rows[{{i}}][firstname]"
                       value="{{ r.firstname }}"
                       class="w-full border p-1 text-xs {% if e.get('firstname') %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}"
                       style="border-radius: 0.25rem;">
                {% if e.get('firstname') %}<div class="text-xs text-red-600 mt-1">{{ e['firstname'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                <input name="rows[{{i}}][lastname]"
                       value="{{ r.lastname }}"
                       class="w-full border p-1 text-xs {% if e.get('lastname') %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}"
                       style="border-radius: 0.25rem;">
                {% if e.get('lastname') %}<div class="text-xs text-red-600 mt-1">{{ e['lastname'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                <input name="rows[{{i}}][email]"
                       value="{{ r.email }}"
                       class="w-full border p-1 text-xs {% if e.get('email') %}border-red-500 bg-red-50{% elif w.get('email') %}border-yellow-500 bg-yellow-50{% else %}border-gray-300{% endif %}"
                       style="border-radius: 0.25rem;">
                {% if e.get('email') %}<div class="text-xs text-red-600 mt-1">{{ e['email'] }}</div>{% endif %}
                {% if w.get('email') %}<div class="text-xs text-yellow-700 mt-1">⚠️ {{ w['email'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                <input name="rows[{{i}}][birthdate]"
                       value="{{ r.birthdate }}"
                       placeholder="DD.MM.YYYY"
                       class="w-full border p-1 text-xs {% if e.get('birthdate') %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}"
                       style="border-radius: 0.25rem;">
                {% if e.get('birthdate') %}<div class="text-xs text-red-600 mt-1">{{ e['birthdate'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                <select name="rows[{{i}}][gender]"
                        class="w-full border p-1 text-xs {% if e.get('gender') %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}"
                        style="border-radius: 0.25rem;">
                  <option value="m" {% if r.gender=='m' %}selected{% endif %}>m</option>
                  <option value="w" {% if r.gender=='w' %}selected{% endif %}>w</option>
                  <option value="d" {% if r.gender=='d' %}selected{% endif %}>d</option>
                </select>
                {% if e.get('gender') %}<div class="text-xs text-red-600 mt-1">{{ e['gender'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                <input name="rows[{{i}}][member_since]"
                       value="{{ r.member_since }}"
                       placeholder="YYYY"
                       class="w-full border p-1 text-xs {% if e.get('member_since') %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}"
                       style="border-radius: 0.25rem;">
                {% if e.get('member_since') %}<div class="text-xs text-red-600 mt-1">{{ e['member_since'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                <select name="rows[{{i}}][group_id]"
                        class="w-full border p-1 text-xs {% if e.get('group_name') %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %}"
                        style="border-radius: 0.25rem;">
                  {% for g in GROUPS %}
                    <option value="{{ g.id }}" {% if r.group_id == g.id %}selected{% endif %}>{{ g.name }}</option>
                  {% endfor %}
                </select>
                {% if e.get('group_name') %}<div class="text-xs text-red-600 mt-1">{{ e['group_name'] }}</div>{% endif %}
              </td>

              <td class="px-3 py-2">
                {% if e and e|length > 0 %}
                  <span class="inline-block text-xs px-2 py-1 rounded bg-red-100 text-red-800 border border-red-300">Fehler</span>
                {% elif w and w|length > 0 %}
                  <span class="inline-block text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800 border border-yellow-300">Warnung</span>
                {% else %}
                  <span class="inline-block text-xs px-2 py-1 rounded bg-green-100 text-green-800 border border-green-300">OK</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="flex-shrink: 0; padding: 1rem; border-top: 1px solid #e5e7eb; background-color: #f9fafb;">
      <div class="flex items-center gap-2 mb-2">
        <button type="button"
                class="px-4 py-2 rounded bg-gray-600 text-white hover:bg-gray-700 text-sm font-medium flex items-center gap-2"
                hx-post="/htmx/members/import-revalidate"
                hx-include="#import-form"
                hx-target="#import-area"
                hx-indicator="#revalidate-spinner">
          Erneut prüfen
          <div id="revalidate-spinner" class="htmx-indicator">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </button>

        {% set error_count = rows | selectattr('_errors') | list | length %}
        {% set warning_count = rows | selectattr('_warnings') | list | length %}
        <button type="button"
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                hx-post="/htmx/members/import-commit"
                hx-include="#import-form"
                hx-target="#import-area"
                hx-indicator="#commit-spinner"
                {% if error_count > 0 %}disabled{% endif %}
                {% if error_count > 0 %}title="Bitte beheben Sie erst alle Fehler"{% elif warning_count > 0 %}title="Es gibt {{ warning_count }} Warnungen (z.B. doppelte E-Mails)"{% endif %}>
          Speichern (ersetzt Mitgliederliste){% if warning_count > 0 and error_count == 0 %} trotz Warnungen{% endif %}
          <div id="commit-spinner" class="htmx-indicator">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </button>

        <a href="/members"
           class="px-4 py-2 rounded bg-gray-300 text-gray-900 hover:bg-gray-400 text-sm font-medium">
          Verwerfen
        </a>
      </div>

      <div class="text-xs text-gray-500">
        Hinweis: Beim Speichern wird die bestehende Mitgliederliste vollständig ersetzt.
      </div>
    </div>
  </form>
</div>
