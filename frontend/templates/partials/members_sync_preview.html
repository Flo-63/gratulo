<!--
===============================================================================
Project   : gratulo
Module    : frontend/templates/partials/members_sync_preview.html
Created   : 2026-02-06
Author    : Florian
Purpose   : Shows preview of member synchronization (deletions and additions)

@docstyle: google
@language: english
@voice: imperative
===============================================================================
-->

<div id="import-area" class="bg-white shadow rounded-lg p-6">
  <div class="mb-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">CSV Abgleich - Vorschau der Änderungen</h3>

    <div class="flex flex-wrap gap-3 mb-4">
      <div class="bg-red-50 border border-red-200 rounded p-3 flex-1 min-w-[150px]">
        <div class="text-red-800 font-semibold text-lg">{{ to_delete|length }}</div>
        <div class="text-red-600 text-sm">Werden gelöscht</div>
      </div>
      <div class="bg-green-50 border border-green-200 rounded p-3 flex-1 min-w-[150px]">
        <div class="text-green-800 font-semibold text-lg">{{ to_add|length }}</div>
        <div class="text-green-600 text-sm">Neue Mitglieder</div>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded p-3 flex-1 min-w-[150px]">
        <div class="text-blue-800 font-semibold text-lg">{{ existing|length }}</div>
        <div class="text-blue-600 text-sm">Unverändert</div>
      </div>
      <div class="bg-yellow-50 border border-yellow-300 rounded p-2 text-xs text-yellow-800 flex items-center flex-1 min-w-[200px]">
        <strong>Hinweis:</strong>&nbsp;Nicht in CSV = deaktiviert
      </div>
    </div>
  </div>

  <form id="sync-form">
    <!-- Members to delete -->
    <div class="mb-6">
      <h4 class="text-lg font-semibold text-red-700 mb-3">
        ❌ Werden deaktiviert ({{ to_delete|length }})
      </h4>
      {% if to_delete %}
      <div class="border border-red-200 rounded overflow-hidden" style="max-height: 300px; overflow-y: auto;">
        <table class="w-full text-sm">
          <thead class="bg-red-50 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-red-700">Vorname</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-red-700">Nachname</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-red-700">E-Mail</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-red-700">Gruppe</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-red-100">
            {% for member in to_delete %}
            <tr class="bg-white hover:bg-red-50">
              <td class="px-3 py-2">{{ member.firstname }}</td>
              <td class="px-3 py-2">{{ member.lastname }}</td>
              <td class="px-3 py-2">{{ member.email }}</td>
              <td class="px-3 py-2">{{ member.group.name if member.group else '—' }}</td>
              <input type="hidden" name="delete_{{ member.id }}" value="1">
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="border border-gray-200 rounded p-4 text-center text-gray-500 text-sm">
        Keine Mitglieder werden deaktiviert
      </div>
      {% endif %}
    </div>

    <!-- New members to add -->
    <div class="mb-6">
      <h4 class="text-lg font-semibold text-green-700 mb-3">
        ✅ Werden hinzugefügt ({{ to_add|length }})
      </h4>
      {% if to_add %}
      <div class="border border-green-200 rounded overflow-hidden" style="max-height: 300px; overflow-y: auto;">
        <table class="w-full text-sm">
          <thead class="bg-green-50 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-green-700">Vorname</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-green-700">Nachname</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-green-700">E-Mail</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-green-700">Geb.datum</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-green-700">Geschlecht</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-green-700">Gruppe</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-green-100">
            {% for row in to_add %}
            {% set i = loop.index0 %}
            <tr class="bg-white hover:bg-green-50">
              <td class="px-3 py-2">{{ row.firstname }}</td>
              <td class="px-3 py-2">{{ row.lastname }}</td>
              <td class="px-3 py-2">{{ row.email }}</td>
              <td class="px-3 py-2">{{ row.birthdate }}</td>
              <td class="px-3 py-2">
                <select name="add[{{i}}][gender]"
                        class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                  <option value="m" {% if row.gender == 'm' %}selected{% endif %}>m</option>
                  <option value="w" {% if row.gender == 'w' %}selected{% endif %}>w</option>
                  <option value="d" {% if row.gender == 'd' %}selected{% endif %}>d</option>
                </select>
              </td>
              <td class="px-3 py-2">
                <select name="add[{{i}}][group_id]"
                        class="w-full border border-gray-300 rounded px-2 py-1 text-xs"
                        onchange="this.closest('tr').querySelector('input[name=\'add[{{i}}][group_name]\']').value = this.options[this.selectedIndex].textContent.trim();">
                  {% for g in GROUPS %}
                    <option value="{{ g.id }}"
                            {% if row.group_id and (row.group_id|int == g.id or row.group_id == g.id) %}selected{% endif %}>
                      {{ g.name }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <!-- Hidden inputs to pass data -->
              <input type="hidden" name="add[{{i}}][firstname]" value="{{ row.firstname }}">
              <input type="hidden" name="add[{{i}}][lastname]" value="{{ row.lastname }}">
              <input type="hidden" name="add[{{i}}][email]" value="{{ row.email }}">
              <input type="hidden" name="add[{{i}}][birthdate]" value="{{ row.birthdate }}">
              <input type="hidden" name="add[{{i}}][member_since]" value="{{ row.member_since }}">
              <input type="hidden" name="add[{{i}}][group_name]" value="{{ row.group_name }}">
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="border border-gray-200 rounded p-4 text-center text-gray-500 text-sm">
        Keine neuen Mitglieder
      </div>
      {% endif %}
    </div>

    <!-- Action buttons -->
    <div class="flex items-center gap-3 pt-4 border-t">
      {% if to_delete or to_add %}
      <button type="button"
              class="px-5 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 font-medium flex items-center gap-2"
              hx-post="/htmx/members/sync-commit"
              hx-include="#sync-form"
              hx-indicator="#sync-spinner"
              hx-confirm="Abgleich durchführen? Es werden {{ to_delete|length }} Mitglieder deaktiviert und {{ to_add|length }} neue hinzugefügt.">
        Abgleich durchführen
        <div id="sync-spinner" class="htmx-indicator">
          <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
      </button>
      {% else %}
      <div class="text-green-700 font-medium">
        ✅ Keine Änderungen erforderlich – alle Mitglieder sind bereits synchron.
      </div>
      {% endif %}

      <a href="/members"
         class="px-5 py-2 rounded bg-gray-300 text-gray-900 hover:bg-gray-400 font-medium">
        Abbrechen
      </a>
    </div>
  </form>
</div>
