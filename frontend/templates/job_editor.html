{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto mt-10 space-y-8">
  <h1 class="text-2xl font-bold text-gray-800">
    {% if job %}Job bearbeiten{% else %}Neuen Job anlegen{% endif %}
  </h1>

  {% set initial_mode = 'once' if job and job.once_at else 'regular' %}
  {% set cron_value = job.cron if job and job.cron else '' %}

  <form
    hx-post="/htmx/jobs"
    hx-swap="none"
    x-data="jobEditorState('{{ initial_mode }}', '{{ cron_value }}')"
    x-init="init()"
    class="space-y-8"
  >
    {% if job %}
      <input type="hidden" name="id" value="{{ job.id }}">
    {% endif %}

    <!-- üü¶ Job-Informationen -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Job-Informationen</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" name="name" value="{{ job.name if job else '' }}"
                 placeholder="z. B. Geburtstagsgr√º√üe morgens"
                 required
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Betreff</label>
          <input type="text" name="subject" value="{{ job.subject if job else '' }}"
                 placeholder="z. B. Herzlichen Gl√ºckwunsch!"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
      </div>
    </div>

    <!--Zielgruppe -->
  <div class="bg-white shadow rounded-lg p-6">
  <h2 class="text-lg font-semibold text-gray-700 mb-4">Zielgruppe</h2>

  <!-- Zeile 1: Vorlage -->
  <div class="mb-6 w-64">
    <label class="block text-sm font-medium text-gray-700">Vorlage</label>
    <select name="template_id" required
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      <option disabled {% if not job %}selected{% endif %}>Bitte w√§hlen‚Ä¶</option>
      {% for t in templates %}
        <option value="{{ t.id }}" {% if job and job.template_id == t.id %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Zeile 2: Selektion + Gruppe -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="w-64">
      <label class="block text-sm font-medium text-gray-700">Selektion</label>
      <select name="selection"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        <option value="all" {% if job and job.selection == 'all' %}selected{% endif %}>Alle Mitglieder</option>
        <option value="birthdate" {% if job and job.selection == 'birthdate' %}selected{% endif %}>Geburtstag</option>
        <option value="entry" {% if job and job.selection == 'entry' %}selected{% endif %}>Eintritt</option>
      </select>
    </div>
    <div class="w-64">
      <label class="block text-sm font-medium text-gray-700">Gruppe</label>
      <select name="group_id" required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        {% for g in groups %}
          <option value="{{ g.id }}"
            {% if job and job.group_id == g.id %}
              selected
            {% elif not job and g.is_default %}
              selected
            {% endif %}>
            {{ g.name }}{% if g.is_default %} (Standard){% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>



    <!-- Zeitplanung -->
    <div class="bg-white shadow rounded-lg p-6 space-y-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Zeitplanung</h2>

      <!-- Modus -->
      <div class="flex gap-6">
        <label class="flex items-center gap-2">
          <input type="radio" name="mode" value="once" x-model="mode"
                 class="text-blue-600 focus:ring-blue-500"> Einmalig
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="mode" value="regular" x-model="mode"
                 class="text-blue-600 focus:ring-blue-500"> Regelm√§√üig
        </label>
      </div>

      <!-- Einmalig -->
      <div x-show="mode === 'once'">
        <label class="block text-sm font-medium text-gray-700">Datum & Uhrzeit</label>
        <input type="datetime-local" name="once_at"
               value="{{ job.once_at_local.strftime('%Y-%m-%dT%H:%M') if job and job.once_at else '' }}"
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      </div>

      <!-- Regelm√§√üig -->
      <div x-show="mode === 'regular'" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700">Intervall</label>
          <select name="interval_type" x-model="intervalType"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="daily">T√§glich</option>
            <option value="weekly">W√∂chentlich</option>
            <option value="monthly">Monatlich</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Uhrzeit</label>
          <input type="time" name="time" value="06:00"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div x-show="intervalType === 'weekly'">
          <label class="block text-sm font-medium text-gray-700">Wochentag</label>
          <select name="weekday"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="1">Montag</option>
            <option value="2">Dienstag</option>
            <option value="3">Mittwoch</option>
            <option value="4">Donnerstag</option>
            <option value="5">Freitag</option>
            <option value="6">Samstag</option>
            <option value="0">Sonntag</option>
          </select>
        </div>
        <div x-show="intervalType === 'monthly'">
          <label class="block text-sm font-medium text-gray-700">Tag im Monat</label>
          <input type="number" name="monthday" min="1" max="28" value="1"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
      </div>
    </div>

    <!-- üü• Aktionen -->
    <div class="flex justify-end gap-3">
      <a href="/jobs"
         class="btn btn-gray">
        Abbrechen
      </a>
      <button type="submit"
              class="btn btn-blue">
        Speichern
      </button>
    </div>
  </form>
</div>

<script>
function jobEditorState(modeInit, cron) {
  return {
    mode: modeInit || 'regular',
    intervalType: 'daily',
    init() {
      if (!cron) return;
      const parts = cron.trim().split(/\s+/);
      if (parts.length < 5) return;
      const m = parts[0], h = parts[1], dom = parts[2], dow = parts[4];

      const hh = String(parseInt(h || '6', 10)).padStart(2, '0');
      const mm = String(parseInt(m || '0', 10)).padStart(2, '0');
      const timeEl = document.querySelector('input[name="time"]');
      if (timeEl) timeEl.value = `${hh}:${mm}`;

      if (dom && dom !== '*' && !Number.isNaN(parseInt(dom, 10))) {
        this.intervalType = 'monthly';
        const mdEl = document.querySelector('input[name="monthday"]');
        if (mdEl) mdEl.value = String(parseInt(dom, 10));
      } else if (dow && dow !== '*' && !Number.isNaN(parseInt(dow, 10))) {
        this.intervalType = 'weekly';
        const wdEl = document.querySelector('select[name="weekday"]');
        if (wdEl) wdEl.value = String(parseInt(dow, 10));
      } else {
        this.intervalType = 'daily';
      }
    }
  }
}
</script>
<script src="https://unpkg.com/alpinejs" defer></script>
{% endblock %}
