{% extends "base.html" %}

{% block content %}
<div class="max-w-3xl mx-auto mt-10 space-y-8">
  <h1 class="text-2xl font-bold text-gray-800">
    {% if job %}Job bearbeiten{% else %}Neuen Job anlegen{% endif %}
    {% set cron_parts = job.cron.split(' ') if job and job.cron else [] %}
    {% set minute = cron_parts[0] if cron_parts|length > 0 else '0' %}
    {% set hour = cron_parts[1] if cron_parts|length > 1 else '6' %}
    {% set day_of_month = cron_parts[2] if cron_parts|length > 2 else '*' %}
    {% set day_of_week = cron_parts[4] if cron_parts|length > 4 else '*' %}
  </h1>

  {% set initial_mode = 'once' if job and job.once_at else 'regular' %}
  {% set cron_value = job.cron if job and job.cron else '' %}

  <form
    hx-post="/htmx/jobs"
    hx-swap="none"
    x-data="{
      mode: '{{ initial_mode }}',
      intervalType:
        {% if day_of_month == '*' and day_of_week == '*' %}
          'daily'
        {% elif day_of_week != '*' %}
          'weekly'
        {% elif day_of_month != '*' %}
          'monthly'
        {% else %}
          'daily'
        {% endif %},
      selection: '{{ job.selection if job else 'all' }}'
    }"
    class="space-y-8"
  >
    {% if job %}
      <input type="hidden" name="id" value="{{ job.id }}">
    {% endif %}

    <!-- üü¶ Job-Informationen -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Job-Informationen</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" name="name" value="{{ job.name if job else '' }}"
                 placeholder="z. B. Geburtstagsgr√º√üe morgens"
                 required
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>

        <!-- Betreff -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Betreff</label>
          <input type="text" name="subject" value="{{ job.subject if job else '' }}"
                 placeholder="z. B. Herzlichen Gl√ºckwunsch!"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>

        <!-- üÜï BCC-Adresse -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">BCC-Empf√§nger (optional)</label>
          <input type="email" name="bcc_address" value="{{ job.bcc_address if job and job.bcc_address else '' }}"
                 placeholder="z. B. archiv@example.com"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
          <!-- <p class="text-xs text-gray-500 mt-1">Optional: Eine zus√§tzliche E-Mail-Adresse, die Kopien aller versendeten Mails erh√§lt.</p> -->
        </div>
      </div>
    </div>


    <!-- üü© Zielgruppe -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Zielgruppe</h2>

      <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Standardvorlage -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Vorlage</label>
          <select name="template_id" required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option disabled {% if not job %}selected{% endif %}>Bitte w√§hlen‚Ä¶</option>
            {% for t in templates %}
              <option value="{{ t.id }}" {% if job and job.template_id == t.id %}selected{% endif %}>
                {{ t.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- üü° Vorlage (Runde Jubil√§en) -->
        {% if labels.date1_type == "ANNIVERSARY" %}
          <div x-show="selection === 'date1'">
            <label class="block text-sm font-medium text-gray-700">Vorlage (Runde Jubil√§en)</label>
            <select name="round_template_id"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <option value="">‚Äì Optional w√§hlen ‚Äì</option>
              {% for t in templates %}
                <option value="{{ t.id }}" {% if job and job.round_template_id == t.id %}selected{% endif %}>
                  {{ t.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endif %}

        {% if labels.date2_type == "ANNIVERSARY" %}
          <div x-show="selection === 'date2'">
            <label class="block text-sm font-medium text-gray-700">Vorlage (Runde Jubil√§en)</label>
            <select name="round_template_id"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <option value="">‚Äì Optional w√§hlen ‚Äì</option>
              {% for t in templates %}
                <option value="{{ t.id }}" {% if job and job.round_template_id == t.id %}selected{% endif %}>
                  {{ t.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endif %}



      <!-- Selektion + Gruppe -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700">Selektion</label>
          <select name="selection" x-model="selection"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
              <option value="all" {% if job and job.selection == 'all' %}selected{% endif %}>
                Alle {{ labels.entity_plural }}
              </option>

              {% if labels.date1 %}
                <option value="date1" {% if job and job.selection == 'date1' %}selected{% endif %}>
                  {{ labels.date1 }}
                </option>
              {% endif %}

              {% if labels.date2 %}
                <option value="date2" {% if job and job.selection == 'date2' %}selected{% endif %}>
                  {{ labels.date2 }}
                </option>
              {% endif %}
           </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Gruppe</label>
          <select name="group_id" required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            {% for g in groups %}
              <option value="{{ g.id }}"
                {% if job and job.group_id == g.id %}
                  selected
                {% elif not job and g.is_default %}
                  selected
                {% endif %}>
                {{ g.name }}{% if g.is_default %} (Standard){% endif %}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- üïì Zeitplanung -->
    <div class="bg-white shadow rounded-lg p-6 space-y-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-4">Zeitplanung</h2>

      <div class="flex gap-6">
        <label class="flex items-center gap-2">
          <input type="radio" name="mode" value="once" x-model="mode"
                 class="text-blue-600 focus:ring-blue-500"> Einmalig
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="mode" value="regular" x-model="mode"
                 class="text-blue-600 focus:ring-blue-500"> Regelm√§√üig
        </label>
      </div>

      <!-- Einmalig -->
      <div x-show="mode === 'once'">
        <label class="block text-sm font-medium text-gray-700">Datum & Uhrzeit</label>
        <input type="datetime-local" name="once_at"
               value="{{ job.once_at_local.strftime('%Y-%m-%dT%H:%M') if job and job.once_at else '' }}"
               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
      </div>

      <!-- Regelm√§√üig -->
      <div x-show="mode === 'regular'" x-data="{ showWeekly: false, showMonthly: false }" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Intervall -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Intervall</label>
          <select name="interval_type" x-model="intervalType"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            <option value="daily">T√§glich</option>
            <option value="weekly">W√∂chentlich</option>
            <option value="monthly">Monatlich</option>
          </select>
        </div>

        <!-- Uhrzeit -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Uhrzeit</label>
          <input type="time" name="time"
                 value="{{ '%02d:%02d' | format(hour|int, minute|int) if job and job.cron else '06:00' }}"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>

        <!-- Wochentag -->
        <div x-show="intervalType === 'weekly'">
          <label class="block text-sm font-medium text-gray-700">Wochentag</label>
          <select name="weekday"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            {% for i, name in [(1,'Montag'),(2,'Dienstag'),(3,'Mittwoch'),(4,'Donnerstag'),(5,'Freitag'),(6,'Samstag'),(0,'Sonntag')] %}
              <option value="{{ i }}" {% if day_of_week|int == i %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Monatstag -->
        <div x-show="intervalType === 'monthly'">
          <label class="block text-sm font-medium text-gray-700">Tag im Monat</label>
          <input type="number" name="monthday" min="1" max="28"
                 value="{{ day_of_month if day_of_month != '*' else 1 }}"
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
      </div>
    </div>

    <!-- üü• Aktionen -->
    <div class="flex justify-end gap-3">
      <a href="/jobs" class="btn btn-gray">Abbrechen</a>
      <button type="submit" class="btn btn-blue">Speichern</button>
    </div>
  </form>
</div>

<script src="{{ url_for('static', path='js/job_editor_state.js') }}" defer nonce="{{ csp_nonce }}"></script>
{% endblock %}
